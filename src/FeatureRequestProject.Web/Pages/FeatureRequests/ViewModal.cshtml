@page
@using FeatureRequestProject.Localization
@using FeatureRequestProject.Web.Pages.FeatureRequests
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@using Volo.Abp.Users
@model ViewModalModel
@inject ICurrentUser CurrentUser
@inject IStringLocalizer<FeatureRequestProjectResource> L
@{
    Layout = null;
}

<link href="../Pages/FeatureRequests/ViewModal/ViewModal.css" rel="stylesheet" />

<abp-modal size="Large" centered="true">
    <abp-modal-header title="@Model.FeatureRequest.Title"></abp-modal-header>

    <abp-modal-body class="modal-body-custom-layout">

        <div class="modal-top-content">
            <abp-card class="shadow-sm border-0 mb-3">
                <abp-card-body class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-brand-purple fw-bold mb-0">@L["Description"]</h6>
                        <div class="author-info">
                            <i class="fa fa-user-circle"></i>
                            <span class="fw-bold ms-1">
                                @(string.IsNullOrEmpty(Model.FeatureRequest.CreatorUserName) ? "Unknown" : Model.FeatureRequest.CreatorUserName)
                            </span>
                        </div>
                    </div>
                    <p class="text-black-50 mb-0 description-area" style="white-space: pre-wrap; font-size: 0.95rem;">@Model.FeatureRequest.Description</p>
                </abp-card-body>
            </abp-card>

            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                <span class="custom-badge badge-cat-@Model.FeatureRequest.CategoryId.ToString().ToLower()">
                    <i class="fa fa-tag me-1"></i> @L[$"Enum:Category.{(int)Model.FeatureRequest.CategoryId}"]
                </span>
                <span class="custom-badge badge-status-@Model.FeatureRequest.Status.ToString().ToLower()">
                    <i class="fa fa-info-circle me-1"></i> @L[$"Enum:Status.{(int)Model.FeatureRequest.Status}"]
                </span>

                <div class="vr mx-2 text-secondary opacity-25" style="height: 20px;"></div>

                <span class="stat-badge stat-badge-success" title="@L["TotalUpvotes"]">
                    <i class="fa fa-thumbs-up"></i>
                    <span class="fw-bold">@Model.FeatureRequest.UpVoteCount</span>
                </span>
                <span class="stat-badge stat-badge-danger" title="@L["TotalDownvotes"]">
                    <i class="fa fa-thumbs-down"></i>
                    <span class="fw-bold">@Model.FeatureRequest.DownVoteCount</span>
                </span>
            </div>

            <div class="voting-action-bar">
                <div class="d-flex align-items-center">
                    <i class="fa fa-question-circle text-muted me-2"></i>
                    <span class="voting-label">@L["DidYouFindThisHelpful"]</span>
                </div>
                <div class="btn-group">
                    <abp-button button-type="@(Model.FeatureRequest.CurrentUserVote == 1 ? Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Button.AbpButtonType.Success : Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Button.AbpButtonType.Outline_Success)"
                                size="Small" icon="thumbs-up" text="@L["Yes"].Value" class="modal-vote-btn px-3"
                                data-id="@Model.FeatureRequest.Id" data-type="1" />
                    <abp-button button-type="@(Model.FeatureRequest.CurrentUserVote == -1 ? Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Button.AbpButtonType.Danger : Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Button.AbpButtonType.Outline_Danger)"
                                size="Small" icon="thumbs-down" text="@L["No"].Value" class="modal-vote-btn px-3"
                                data-id="@Model.FeatureRequest.Id" data-type="-1" />
                </div>
            </div>

            <div class="section-header">
                <i class="fa fa-comments me-2"></i> @L["Comments"]
            </div>
        </div>

        <div id="comments-section" class="custom-scroll-area">
            @if (Model.FeatureRequest.Comments == null || !Model.FeatureRequest.Comments.Any())
            {
                <div class="text-center py-5">
                    <i class="fa fa-comment-slash fa-2x text-muted opacity-25 mb-3"></i>
                    <p class="text-muted">@L["NoCommentsYet"]</p>
                </div>
            }
            else
            {
                @foreach (var comment in Model.FeatureRequest.Comments.OrderByDescending(c => c.CreationTime))
                {
                    <div class="comment-container mb-3 border-bottom pb-3">
                        <div class="d-flex gap-3">
                            <div class="comment-avatar-circle flex-shrink-0">
                                @(string.IsNullOrEmpty(comment.UserName) ? "?" : comment.UserName.Substring(0, 1).ToUpper())
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold text-dark" style="font-size: 0.9rem;">@comment.UserName</span>
                                    <span class="text-muted small">@comment.CreationTime.ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                                <p class="comment-text">@comment.Content</p>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        @if (CurrentUser.IsAuthenticated)
        {
            <div class="sticky-bottom-area">
                <div class="d-flex gap-2">
                    <div class="flex-grow-1">
                        <abp-input asp-for="@Model.NewCommentContent"
                                   suppress-label="true"
                                   rows="1"
                                   placeholder="@L["WriteACommentPlaceholder"].Value"
                                   class="form-control border-0"
                                   style="resize: none;" />
                    </div>
                    <div>
                        <abp-button button-type="Primary"
                                    icon="paper-plane"
                                    id="btn-send-comment"
                                    data-id="@Model.FeatureRequest.Id"
                                    class="btn-brand-purple"
                                    title="@L["Send"].Value" />
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="sticky-bottom-area">
                <abp-alert type="Warning" class="mb-0 py-2">
                    @L["LoginToCommentMessage", "/Account/Login"]
                </abp-alert>
            </div>
        }

    </abp-modal-body>

    <abp-modal-footer>
        <abp-button data-bs-dismiss="modal" button-type="Secondary">@L["Close"]</abp-button>
    </abp-modal-footer>

</abp-modal>